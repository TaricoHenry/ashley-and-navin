# Firebase Functions (Ashley Wedding)

This folder contains the backend API for the wedding site:
- Firebase Cloud Functions v2 (HTTPS)
- Express API
- Firestore (Admin SDK)

## Endpoints

### Public
Base path: `/v1`

- `GET /token/:tokenId/status`
  - Returns token status and values:
    - `token`, `guestName`, `route`, `valid`, `usedAt` (null when unused)
- `GET /token/:tokenId/resolve`
  - Redirects based on token validity/route
- `POST /token/:tokenId/reply`
  - Accepts RSVP payload (validated + normalized)
  - Writes to `responses/{token}`
  - Marks `invites/{token}.usedAt` with server timestamp

### Admin (Basic Auth)
- `GET /admin` (HTML dashboard)
- `GET /admin/data` (JSON: invites + responses)
- `POST /admin/invites` (creates invite; token is autogenerated)
- `PATCH /admin/:collection/:id` (edits fields)

## Token Rules
- Token is a 6-character alphanumeric string.
- Firestore doc id for invites is the token: `invites/{token}`.
- Invite URL format:
  - `https://ash-wedding/token/{token}`

## Rate Limiting
A simple in-memory rate limiter is used:
- `/token/:tokenId/reply` is rate-limited to reduce spam
- `/admin/*` is rate-limited to reduce brute force / scraping

> Note: In-memory limits reset on cold start and aren't shared across instances.

## Secrets (Production)
Admin Basic Auth credentials are stored as Cloud Functions secrets:
- `ADMIN_USER`
- `ADMIN_PASS`

Set them:
```bash
firebase functions:secrets:set ADMIN_USER
firebase functions:secrets:set ADMIN_PASS
```
